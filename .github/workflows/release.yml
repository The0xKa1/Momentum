name: Build & Release (Multi-Platform)

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  PROJECT_DIR: fitflow/fitflow

jobs:
  android:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "stable"
      - run: flutter pub get
        working-directory: ${{ env.PROJECT_DIR }}
      - run: flutter build apk --release
        working-directory: ${{ env.PROJECT_DIR }}
      - uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.PROJECT_DIR }}/build/app/outputs/flutter-apk/app-release.apk

  windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "stable"
      - run: flutter config --enable-windows-desktop
      - run: flutter pub get
        working-directory: ${{ env.PROJECT_DIR }}
      - run: flutter build windows --release
        working-directory: ${{ env.PROJECT_DIR }}
      - name: Zip Windows build
        run: |
          Compress-Archive -Path "${{ env.PROJECT_DIR }}\build\windows\x64\runner\Release\*" -DestinationPath "windows-release.zip"
      - uses: softprops/action-gh-release@v2
        with:
          files: windows-release.zip

  macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "stable"
      - run: flutter config --enable-macos-desktop
      - run: flutter pub get
        working-directory: ${{ env.PROJECT_DIR }}
      - run: flutter build macos --release
        working-directory: ${{ env.PROJECT_DIR }}
      - name: Zip macOS build
        run: |
          ditto -c -k --sequesterRsrc --keepParent "${{ env.PROJECT_DIR }}/build/macos/Build/Products/Release" macos-release.zip
      - uses: softprops/action-gh-release@v2
        with:
          files: macos-release.zip

  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "stable"
      - run: sudo apt-get update && sudo apt-get install -y ninja-build libgtk-3-dev
      - run: flutter config --enable-linux-desktop
      - run: flutter pub get
        working-directory: ${{ env.PROJECT_DIR }}
      - run: flutter build linux --release
        working-directory: ${{ env.PROJECT_DIR }}
      - name: Zip Linux build
        run: |
          cd "${{ env.PROJECT_DIR }}/build/linux/x64/release/bundle"
          zip -r ../../../../../linux-release.zip .
      - uses: softprops/action-gh-release@v2
        with:
          files: linux-release.zip